# QMS-Nexus 集成测试用例设计文档

## 1. 测试目标与范围

### 1.1 测试目标
验证QMS-Nexus系统从文件上传到最终问答的完整RAG链路，确保各组件协同工作正常，接口符合规范，异常情况处理完善。

### 1.2 测试范围
- **文件上传接口** (`/upload`): PDF、Word、Excel、PPT文件上传
- **任务状态查询** (`/upload/status/{task_id}`): 异步任务状态轮询
- **语义搜索** (`/search`): 向量检索与结果返回
- **问答接口** (`/ask`): RAG问答功能
- **健康检查** (`/health`): 系统状态监控
- **监控指标** (`/metrics`): Prometheus指标暴露

## 2. 测试方法论

### 2.1 边界值分析 (Boundary Value Analysis)
针对数值型参数，测试边界值及边界附近的值：
- `top_k`: 1, 5, 100, 101, 0, -1
- `file.size`: 0, 1MB, 49MB, 50MB, 51MB
- `timeout`: 0, 1, 30, 60, 61秒

### 2.2 等价类划分 (Equivalence Partitioning)
将输入域划分为有效和无效等价类：
- **文件类型**: 有效(PDF/DOCX/XLSX/PPTX) vs 无效(JPG/TXT/EXE)
- **查询文本**: 有效(非空字符串) vs 无效(空字符串/None)
- **任务ID**: 有效(UUID格式) vs 无效(随机字符串)

### 2.3 异常处理测试 (Error Handling)
验证系统对异常情况的处理能力：
- 网络超时
- Redis连接失败
- 文件损坏
- LLM服务不可用
- 向量数据库异常

## 3. 详细测试用例设计

### 3.1 文件上传接口测试

#### 3.1.1 边界值测试
| 用例ID | 测试场景 | 输入参数 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| UP-BV-01 | 文件大小边界-最小 | 0字节PDF | 400错误 | 高 |
| UP-BV-02 | 文件大小边界-刚好50MB | 50MB PDF | 200成功 | 高 |
| UP-BV-03 | 文件大小边界-超过50MB | 51MB PDF | 413错误 | 高 |
| UP-BV-04 | 文件类型边界-空content-type | 无content-type | 400错误 | 高 |

#### 3.1.2 等价类测试
| 用例ID | 测试场景 | 输入参数 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| UP-EC-01 | 有效文件类型-PDF | test.pdf | 200成功 | 高 |
| UP-EC-02 | 有效文件类型-DOCX | test.docx | 200成功 | 高 |
| UP-EC-03 | 有效文件类型-XLSX | test.xlsx | 200成功 | 高 |
| UP-EC-04 | 无效文件类型-JPG | test.jpg | 400错误 | 中 |
| UP-EC-05 | 无效文件类型-TXT | test.txt | 400错误 | 中 |
| UP-EC-06 | 无效文件类型-EXE | test.exe | 400错误 | 中 |

#### 3.1.3 异常处理测试
| 用例ID | 测试场景 | 输入参数 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| UP-EX-01 | 文件损坏 | 损坏的PDF | 任务状态为Failed | 中 |
| UP-EX-02 | Redis连接失败 | 正常文件 | 任务状态为Pending | 高 |
| UP-EX-03 | 磁盘空间不足 | 大文件 | 500错误 | 低 |

### 3.2 任务状态查询测试

#### 3.2.1 边界值测试
| 用例ID | 测试场景 | 输入参数 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| TS-BV-01 | 任务ID长度边界-最小 | 1字符 | 404错误 | 中 |
| TS-BV-02 | 任务ID格式边界-无效格式 | "invalid-id" | 404错误 | 中 |

#### 3.2.2 等价类测试
| 用例ID | 测试场景 | 输入参数 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| TS-EC-01 | 有效任务ID-存在 | 存在的task_id | 200+状态信息 | 高 |
| TS-EC-02 | 有效任务ID-不存在 | 不存在的task_id | 404错误 | 高 |
| TS-EC-03 | 无效任务ID格式 | 非UUID格式 | 404错误 | 中 |

#### 3.2.3 状态转换测试
| 用例ID | 测试场景 | 初始状态 | 预期转换 | 优先级 |
|--------|----------|----------|------------|--------|
| TS-ST-01 | 正常处理流程 | Pending → Processing → Completed | 状态正确转换 | 高 |
| TS-ST-02 | 处理失败流程 | Pending → Processing → Failed | 状态正确转换 | 高 |

### 3.3 语义搜索接口测试

#### 3.3.1 边界值测试
| 用例ID | 测试场景 | 输入参数 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| SR-BV-01 | top_k边界-最小 | top_k=1 | 返回1个结果 | 高 |
| SR-BV-02 | top_k边界-最大 | top_k=100 | 返回≤100结果 | 高 |
| SR-BV-03 | top_k边界-超过最大 | top_k=101 | 400错误 | 高 |
| SR-BV-04 | top_k边界-零 | top_k=0 | 400错误 | 高 |
| SR-BV-05 | top_k边界-负数 | top_k=-1 | 400错误 | 高 |

#### 3.3.2 等价类测试
| 用例ID | 测试场景 | 输入参数 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| SR-EC-01 | 有效查询-中文 | q="质量方针" | 返回中文结果 | 高 |
| SR-EC-02 | 有效查询-英文 | q="quality policy" | 返回英文结果 | 高 |
| SR-EC-03 | 有效查询-混合 | q="ISO 9001 质量" | 返回混合结果 | 高 |
| SR-EC-04 | 无效查询-空字符串 | q="" | 400错误 | 高 |
| SR-EC-05 | 无效查询-仅空格 | q="   " | 400错误 | 中 |
| SR-EC-06 | 特殊字符查询 | q="@#$%" | 返回空结果或错误 | 中 |

#### 3.3.3 标签过滤测试
| 用例ID | 测试场景 | 输入参数 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| SR-TF-01 | 单标签过滤 | filter_tags=["质量"] | 只返回该标签结果 | 高 |
| SR-TF-02 | 多标签过滤 | filter_tags=["质量","管理"] | 返回匹配任一标签结果 | 高 |
| SR-TF-03 | 不存在标签过滤 | filter_tags=["不存在的标签"] | 返回空结果 | 中 |

### 3.4 问答接口测试

#### 3.4.1 边界值测试
| 用例ID | 测试场景 | 输入参数 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| AS-BV-01 | 问题长度-最短 | question="是" | 返回合理回答 | 高 |
| AS-BV-02 | 问题长度-超长 | question=5000字符 | 截断或错误处理 | 中 |

#### 3.4.2 等价类测试
| 用例ID | 测试场景 | 输入参数 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| AS-EC-01 | 有效问题-事实型 | "什么是质量方针？" | 返回具体定义 | 高 |
| AS-EC-02 | 有效问题-程序型 | "如何制定质量目标？" | 返回步骤说明 | 高 |
| AS-EC-03 | 有效问题-对比型 | "质量管理和质量控制的区别？" | 返回对比分析 | 高 |
| AS-EC-04 | 无效问题-空问题 | question="" | 400错误 | 高 |
| AS-EC-05 | 无关问题 | "今天天气如何？" | "知识库中暂无相关记录" | 中 |

#### 3.4.3 异常处理测试
| 用例ID | 测试场景 | 输入参数 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| AS-EX-01 | LLM服务超时 | 正常问题 | 504超时错误 | 高 |
| AS-EX-02 | LLM服务返回错误 | 正常问题 | 500错误 | 高 |
| AS-EX-03 | 向量数据库异常 | 正常问题 | 500错误 | 高 |

### 3.5 健康检查接口测试

#### 3.5.1 基础健康检查
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| HC-01 | 系统正常运行 | status="ok" | 高 |
| HC-02 | 数据库连接异常 | status="error" | 高 |
| HC-03 | 向量库连接异常 | status="error" | 高 |

### 3.6 监控指标接口测试

#### 3.6.1 指标格式验证
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| MT-01 | Prometheus格式验证 | 包含# HELP和# TYPE | 中 |
| MT-02 | 指标计数器验证 | upload_total递增 | 中 |
| MT-03 | 指标直方图验证 | upload_duration有数据 | 中 |

## 4. 性能测试用例

### 4.1 并发上传测试
| 用例ID | 测试场景 | 并发数 | 预期结果 | 优先级 |
|--------|----------|--------|----------|--------|
| PF-UP-01 | 并发上传 | 5个文件 | 全部成功处理 | 高 |
| PF-UP-02 | 并发上传 | 10个文件 | 全部成功处理 | 中 |
| PF-UP-03 | 大文件并发 | 3个50MB文件 | 在合理时间内完成 | 中 |

### 4.2 搜索性能测试
| 用例ID | 测试场景 | 查询量 | 预期结果 | 优先级 |
|--------|----------|--------|----------|--------|
| PF-SR-01 | 并发搜索 | 10 QPS | 响应时间<2s | 高 |
| PF-SR-02 | 并发搜索 | 50 QPS | 响应时间<5s | 中 |
| PF-SR-03 | 大数据集搜索 | 10000文档 | 返回时间<3s | 中 |

## 5. 安全测试用例

### 5.1 输入验证测试
| 用例ID | 测试场景 | 输入参数 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| SC-01 | SQL注入尝试 | q="'; DROP TABLE..." | 安全过滤，返回空结果 | 高 |
| SC-02 | XSS攻击尝试 | q="<script>alert('xss')</script>" | 安全过滤或错误处理 | 高 |
| SC-03 | 路径遍历攻击 | filename="../../../etc/passwd" | 安全处理，400错误 | 高 |

### 5.2 文件上传安全
| 用例ID | 测试场景 | 输入参数 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| SC-04 | 恶意文件上传 | 包含脚本的PDF | 安全扫描，拒绝或清理 | 高 |
| SC-05 | 文件类型伪装 | .exe重命名为.pdf | 内容检查，拒绝上传 | 高 |

## 6. 测试数据设计

### 6.1 测试文件集合
```
test_files/
├── valid/
│   ├── small.pdf (1KB)           # 最小有效文件
│   ├── medium.pdf (1MB)          # 中等大小文件
│   ├── large.pdf (49MB)          # 最大允许文件
│   ├── corrupted.pdf             # 损坏的PDF文件
│   ├── chinese_content.pdf       # 中文内容文件
│   ├── english_content.pdf       # 英文内容文件
│   ├── mixed_content.pdf         # 混合语言文件
│   ├── tables.pdf                # 包含表格的PDF
│   └── images.pdf                # 包含图片的PDF
├── invalid/
│   ├── oversized.pdf (51MB)      # 超大文件
│   ├── fake.pdf (TXT文件)        # 伪装成PDF的文本文件
│   ├── executable.exe            # 可执行文件
│   └── script.pdf (含JS)         # 包含脚本的PDF
└── special/
    ├── empty.pdf (0字节)         # 空文件
    └── no_extension               # 无扩展名文件
```

### 6.2 测试查询语料
```
queries/
├── valid/
│   ├── factual.txt       # 事实型查询
│   ├── procedural.txt    # 程序型查询
│   ├── comparative.txt   # 对比型查询
│   ├── chinese.txt       # 中文查询
│   ├── english.txt       # 英文查询
│   └── mixed.txt         # 混合语言查询
├── invalid/
│   ├── empty.txt         # 空查询
│   ├── spaces.txt        # 仅空格
│   ├── special.txt       # 特殊字符
│   └── injection.txt     # 注入攻击
└── edge/
    ├── very_long.txt     # 超长查询
    ├── single_char.txt   # 单字符查询
    └── unicode.txt       # Unicode字符
```

## 7. 测试执行策略

### 7.1 测试优先级
1. **P0 (高)**: 核心功能、边界值、安全测试
2. **P1 (中)**: 等价类、异常处理、性能测试
3. **P2 (低)**: 边缘情况、兼容性测试

### 7.2 测试环境
- **开发环境**: 本地开发机，完整Mock
- **CI环境**: GitHub Actions，Redis + ChromaDB服务
- **预发布环境**: 接近生产环境，真实外部服务

### 7.3 测试频率
- **单元测试**: 每次代码提交
- **集成测试**: 每日构建
- **性能测试**: 每周执行
- **安全测试**: 每月执行

## 8. 测试用例实现规划

### 8.1 第一阶段 (核心功能)
- 文件上传基础测试
- 任务状态查询测试
- 搜索接口基础测试
- 问答接口基础测试

### 8.2 第二阶段 (边界异常)
- 边界值测试用例
- 异常处理测试
- 安全测试用例

### 8.3 第三阶段 (性能安全)
- 并发性能测试
- 安全渗透测试
- 长期稳定性测试

## 9. 验收标准

### 9.1 功能验收
- ✅ 所有P0测试用例通过
- ✅ 代码覆盖率>80%
- ✅ 无严重安全漏洞
- ✅ 性能指标达标

### 9.2 文档验收
- ✅ 测试用例文档完整
- ✅ 测试报告清晰
- ✅ 缺陷跟踪到位
- ✅ 测试数据可复用

---

**文档版本**: v1.0  
**创建时间**: 2024年  
**维护团队**: QA架构组  
**评审状态**: 待评审